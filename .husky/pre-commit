#!/usr/bin/env bash
set -euo pipefail

echo "Running pre-commit gate..."

FAILED=0

# 1. Lint and format (via lint-staged for staged files only)
echo "  lint-staged..."
if ! npx lint-staged; then
  echo "  FAIL: lint/format"
  FAILED=1
fi

# 2. TypeScript type check
echo "  tsc --noEmit..."
if ! npx tsc --noEmit; then
  echo "  FAIL: type check"
  FAILED=1
fi

# 3. Tests (fast, bail on first failure)
echo "  tests..."
if ! npm test -- --bail --passWithNoTests 2>/dev/null; then
  echo "  FAIL: tests"
  FAILED=1
fi

if [ "$FAILED" -ne 0 ]; then
  echo "Pre-commit gate failed. Fix the issues above."
  exit 1
fi

echo "Pre-commit gate passed."
