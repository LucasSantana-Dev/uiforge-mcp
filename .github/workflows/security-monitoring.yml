name: Security Monitoring

on:
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      scan_dependencies:
        description: "Scan dependencies for vulnerabilities"
        required: false
        default: true
        type: boolean
      scan_code:
        description: "Run static code security analysis"
        required: false
        default: true
        type: boolean
      create_report:
        description: "Create security summary report"
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security-scan:
    name: Daily Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run Snyk dependency scan
        if: github.event.inputs.scan_dependencies == 'true'
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium
          command: monitor

      - name: Run Snyk code security scan
        if: github.event.inputs.scan_code == 'true'
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --sarif-file-output=snyk-code.sarif
          command: code test

      - name: Upload SARIF to GitHub Security
        if: github.event.inputs.scan_code == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-code.sarif

      - name: Generate security report
        if: github.event.inputs.create_report == 'true'
        run: |
          echo "## ðŸ”’ Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“‹ Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependency scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code security analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Results uploaded to GitHub Security tab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ” Review Findings" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the **Security** tab in this repository" >> $GITHUB_STEP_SUMMARY
          echo "2. Review high and medium severity issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Address critical vulnerabilities promptly" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“Š Snyk Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "View detailed analysis at: https://app.snyk.io/org/your-org/project" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸš¨ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Review and fix high-severity issues" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Update dependencies if needed" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Review code security recommendations" >> $GITHUB_STEP_SUMMARY

  coverage-monitoring:
    name: Coverage Monitoring
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/coverage-final.json,./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true

      - name: Generate coverage report
        run: |
          echo "## ðŸ“Š Coverage Monitoring Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct // 0')
            FUNCTIONS=$(cat coverage/coverage-summary.json | jq '.total.functions.pct // 0')
            BRANCHES=$(cat coverage/coverage-summary.json | jq '.total.branches.pct // 0')
            STATEMENTS=$(cat coverage/coverage-summary.json | jq '.total.statements.pct // 0')
            
            echo "### Coverage Metrics" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Coverage | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY
            
            # Determine status for each metric
            LINE_STATUS="âœ…"
            if (( $(echo "$LINES < 80" | bc -l) )); then
              LINE_STATUS="âŒ"
            fi
            
            FUNC_STATUS="âœ…"
            if (( $(echo "$FUNCTIONS < 80" | bc -l) )); then
              FUNC_STATUS="âŒ"
            fi
            
            BRANCH_STATUS="âœ…"
            if (( $(echo "$BRANCHES < 80" | bc -l) )); then
              BRANCH_STATUS="âŒ"
            fi
            
            STMT_STATUS="âœ…"
            if (( $(echo "$STATEMENTS < 80" | bc -l) )); then
              STMT_STATUS="âŒ"
            fi
            
            echo "| Lines | ${LINES}% | $LINE_STATUS |" >> $GITHUB_STEP_SUMMARY
            echo "| Functions | ${FUNCTIONS}% | $FUNC_STATUS |" >> $GITHUB_STEP_SUMMARY
            echo "| Branches | ${BRANCHES}% | $BRANCH_STATUS |" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | ${STATEMENTS}% | $STMT_STATUS |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Overall status
            if (( $(echo "$LINES >= 80 && $FUNCTIONS >= 80 && $BRANCHES >= 80 && $STATEMENTS >= 80" | bc -l) )); then
              echo "### ðŸŽ‰ Overall Status: HEALTHY" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âš ï¸ Overall Status: NEEDS ATTENTION" >> $GITHUB_STEP_SUMMARY
              echo "Some coverage metrics are below the 80% threshold." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ View Details" >> $GITHUB_STEP_SUMMARY
          echo "- [Codecov Dashboard](https://codecov.io/gh/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Coverage Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

  notify-team:
    name: Notify Team
    runs-on: ubuntu-latest
    if: failure()
    needs: [security-scan, coverage-monitoring]
    steps:
      - name: Create issue for failures
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const title = `Security/Coverage Monitoring Alert - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## ðŸš¨ Monitoring Alert

            The daily security and coverage monitoring workflow has failed.

            ### ðŸ”— Links
            - [Workflow Run](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }})
            - [Security Tab](https://github.com/${owner}/${repo}/security)
            - [Codecov Dashboard](https://codecov.io/gh/${owner}/${repo})

            ### ðŸ“‹ Next Steps
            1. Review the workflow logs
            2. Check for any critical security issues
            3. Verify coverage metrics
            4. Address any failures
            5. Re-run the workflow if needed

            ---
            *This issue was automatically created by the monitoring workflow.*
            `;

            github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ['security', 'coverage', 'monitoring', 'alert']
            });
