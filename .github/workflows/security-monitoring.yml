name: Security Monitoring

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  issues: write

jobs:
  security-scan:
    name: Daily Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: rm -f package-lock.json && npm install --legacy-peer-deps

      - name: Audit production dependencies
        run: npm audit --audit-level=high --omit=dev

      - name: Generate security report
        if: always()
        run: |
          echo "## Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "- npm audit (production deps, high severity)" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL (via security.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- Trufflehog (via security.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- GitGuardian (automatic)" >> $GITHUB_STEP_SUMMARY

  coverage-monitoring:
    name: Coverage Monitoring
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: rm -f package-lock.json && npm install --legacy-peer-deps

      - name: Build
        run: npm run build

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/coverage-final.json,./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true

      - name: Generate coverage report
        run: |
          echo "## Coverage Monitoring Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct // 0')
            FUNCTIONS=$(cat coverage/coverage-summary.json | jq '.total.functions.pct // 0')
            BRANCHES=$(cat coverage/coverage-summary.json | jq '.total.branches.pct // 0')
            STATEMENTS=$(cat coverage/coverage-summary.json | jq '.total.statements.pct // 0')

            echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| Lines | ${LINES}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Functions | ${FUNCTIONS}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Branches | ${BRANCHES}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | ${STATEMENTS}% |" >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

  notify-team:
    name: Notify Team
    runs-on: ubuntu-latest
    if: failure()
    needs: [security-scan, coverage-monitoring]
    steps:
      - name: Create issue for failures
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const date = new Date().toISOString().split('T')[0];
            const title = `Security/Coverage Monitoring Alert - ${date}`;

            const existing = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'monitoring,security',
              per_page: 5,
            });
            const duplicate = existing.data.find(i => i.title === title);
            if (duplicate) {
              console.log(`Issue "${title}" already exists (#${duplicate.number}), skipping.`);
              return;
            }

            const body = [
              '## Monitoring Alert',
              '',
              'The daily security and coverage monitoring workflow has failed.',
              '',
              `- [Workflow Run](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }})`,
              `- [Security Tab](https://github.com/${owner}/${repo}/security)`,
              '',
              '*Auto-created by monitoring workflow.*'
            ].join('\n');

            github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ['security', 'monitoring']
            });
