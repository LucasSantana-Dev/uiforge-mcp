name: Reusable Coverage Upload

on:
  workflow_call:
    inputs:
      coverage-files:
        description: "Coverage files to upload"
        required: false
        default: "./coverage.xml,./htmlcov/"
      flags:
        description: "Coverage flags"
        required: false
        default: "unittests"
      name:
        description: "Coverage report name"
        required: false
        default: "codecov-umbrella"
      fail_ci_if_error:
        description: "Fail CI if upload fails"
        required: false
        default: false
    secrets:
      CODECOV_TOKEN:
        description: "Codecov token"
        required: true

jobs:
  upload-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ${{ inputs.coverage-files }}
          flags: ${{ inputs.flags }}
          name: ${{ inputs.name }}
          fail_ci_if_error: ${{ inputs.fail_ci_if_error }}
          verbose: true

      - name: Generate coverage summary
        run: |
          echo "## ðŸ“Š Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if coverage.xml exists
          if [ -f "coverage.xml" ]; then
            echo "âœ… Coverage XML report found" >> $GITHUB_STEP_SUMMARY
            # Extract coverage percentage if possible
            if command -v xmllint >/dev/null 2>&1; then
              coverage=$(xmllint --xpath "string(//coverage/@line-rate)" coverage.xml 2>/dev/null || echo "N/A")
              echo "ðŸ“ˆ Coverage Rate: ${coverage}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Coverage XML report not found" >> $GITHUB_STEP_SUMMARY
          fi

          # Check if HTML report exists
          if [ -d "htmlcov" ]; then
            echo "âœ… Coverage HTML report generated" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ View detailed report: htmlcov/index.html" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Coverage HTML report not found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [Codecov Dashboard](https://codecov.io/gh/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY

      - name: Coverage badge generation
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "ðŸ“‹ Coverage badge generation would run here"
          echo "This would update README.md with current coverage badge"
          echo "Coverage files: ${{ inputs.coverage-files }}"
          echo "Flags: ${{ inputs.flags }}"
