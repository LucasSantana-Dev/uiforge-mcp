name: Quality Gates

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  quality-check:
    name: Quality Gate Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Check coverage threshold
        run: |
          echo "ğŸ” Checking coverage thresholds..."

          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct // 0')
            echo "Current coverage: ${LINES}%"
            
            if (( $(echo "$LINES >= 70" | bc -l) )); then
              echo "âœ… Coverage threshold met (â‰¥70%)"
            else
              echo "âŒ Coverage threshold not met (<70%)"
              echo "::error::Coverage is ${LINES}%, minimum required is 70%"
              exit 1
            fi
          else
            echo "âŒ Coverage report not found"
            exit 1
          fi

      - name: Check bundle size
        run: |
          echo "ğŸ“¦ Checking bundle size..."

          if [ -f dist/index.js ]; then
            SIZE=$(stat -c%s dist/index.js)
            SIZE_KB=$((SIZE / 1024))
            echo "Bundle size: ${SIZE_KB}KB"
            
            if [ $SIZE_KB -gt 1000 ]; then
              echo "âš ï¸ Bundle size is large: ${SIZE_KB}KB"
            else
              echo "âœ… Bundle size is acceptable: ${SIZE_KB}KB"
            fi
          else
            echo "âŒ Bundle not found"
          fi

      - name: Check for TODO comments
        run: |
          echo "ğŸ“‹ Checking for TODO comments..."

          TODO_COUNT=$(grep -r "TODO\|FIXME\|HACK\|XXX" src/ --include="*.ts" --include="*.js" | wc -l || echo "0")
          echo "TODO/FIXME count: $TODO_COUNT"

          if [ $TODO_COUNT -gt 5 ]; then
            echo "âš ï¸ High number of TODO comments: $TODO_COUNT"
          else
            echo "âœ… TODO count is acceptable: $TODO_COUNT"
          fi

      - name: Validate package.json
        run: |
          echo "ğŸ“„ Validating package.json..."

          # Check for required fields
          if ! jq -e '.name' package.json > /dev/null; then
            echo "âŒ Missing name in package.json"
            exit 1
          fi

          if ! jq -e '.version' package.json > /dev/null; then
            echo "âŒ Missing version in package.json"
            exit 1
          fi

          if ! jq -e '.description' package.json > /dev/null; then
            echo "âš ï¸ Missing description in package.json"
          fi

          echo "âœ… package.json validation passed"

      - name: Check for security issues in dependencies
        run: |
          echo "ğŸ”’ Checking for security issues..."

          # Run npm audit
          AUDIT_OUTPUT=$(npm audit --audit-level=moderate --json 2>/dev/null || echo '{"vulnerabilities": []}')

          if echo "$AUDIT_OUTPUT" | jq -e '.vulnerabilities | length > 0' > /dev/null 2>/dev/null; then
            echo "âš ï¸ Security vulnerabilities found"
            echo "Run 'npm audit' for details"
          else
            echo "âœ… No security vulnerabilities found"
          fi

      - name: Generate quality report
        run: |
          echo "## ğŸ“Š Quality Gate Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### âœ… Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Tests executed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Coverage threshold validated" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Bundle size checked" >> $GITHUB_STEP_SUMMARY
          echo "- [x] TODO comments reviewed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] package.json validated" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Security dependencies checked" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ“ˆ Metrics" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct // 0')
            echo "- Code Coverage: ${LINES}%" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f dist/index.js ]; then
            SIZE=$(stat -c%s dist/index.js)
            SIZE_KB=$((SIZE / 1024))
            echo "- Bundle Size: ${SIZE_KB}KB" >> $GITHUB_STEP_SUMMARY
          fi

          TODO_COUNT=$(grep -r "TODO\|FIXME\|HACK\|XXX" src/ --include="*.ts" --include="*.js" | wc -l || echo "0")
          echo "- TODO Comments: $TODO_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ¯ Quality Score" >> $GITHUB_STEP_SUMMARY
          echo "All quality gates have passed successfully! ğŸ‰" >> $GITHUB_STEP_SUMMARY

  pr-comment:
    name: Add PR Comment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    needs: quality-check
    steps:
      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.number;

            const comment = `## ğŸ” Quality Gate Status

            This PR has passed all automated quality gates!

            ### âœ… Checks Completed
            - [x] Test execution
            - [x] Code coverage (â‰¥80%)
            - [x] Bundle size validation
            - [x] TODO comment review
            - [x] Package.json validation
            - [x] Security dependency check

            ### ğŸ“Š Metrics
            See the detailed quality report in the Actions tab.

            ---
            *This comment was automatically generated by the Quality Gates workflow.*
            `;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: comment
            });
