name: Deploy

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: "Dry run (skip actual publish)"
        required: false
        default: false
        type: boolean
      create_release:
        description: "Create GitHub release"
        required: false
        default: true
        type: boolean
  repository_dispatch:
    types: [automated-release]

permissions:
  contents: write
  id-token: write
  actions: read

jobs:
  # Pre-flight checks (production only)
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      should_publish: ${{ steps.checks.outputs.should_publish }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Check if main branch
        run: |
          if [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
            echo "::error::Deployment can only be run from main branch"
            exit 1
          fi

      - name: Check for uncommitted changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "::error::Working directory is not clean. Commit all changes before deployment."
            exit 1
          fi

      - name: Calculate next version
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"

          # Handle automated release event
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            VERSION="${{ github.event.client_payload.version }}"
            VERSION_TYPE="${{ github.event.client_payload.version_type }}"
            DRY_RUN="${{ github.event.client_payload.dry_run }}"
            CREATE_RELEASE="${{ github.event.client_payload.create_release }}"
            echo "Using automated release: $VERSION ($VERSION_TYPE)"
          else
            case "${{ github.event.inputs.version_type }}" in
              "patch")
                NEXT_VERSION=$(echo $CURRENT_VERSION | awk -F. '{print $1"."$2"."($3+1)}')
                ;;
              "minor")
                NEXT_VERSION=$(echo $CURRENT_VERSION | awk -F. '{print $1"."($2+1)".0"}')
                ;;
              "major")
                NEXT_VERSION=$(echo $CURRENT_VERSION | awk -F. '{print ($1+1)".0.0"}')
                ;;
              *)
                echo "::error::Invalid version type: ${{ github.event.inputs.version_type }}"
                exit 1
                ;;
            esac
            VERSION="$NEXT_VERSION"
            VERSION_TYPE="${{ github.event.inputs.version_type }}"
            DRY_RUN="${{ github.event.inputs.dry_run }}"
            CREATE_RELEASE="${{ github.event.inputs.create_release }}"
          fi

          echo "Next version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT

          # Check if prerelease (contains -)
          if [[ "$VERSION" == *"-" ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if version already exists
        id: checks
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "::error::Version v$VERSION already exists"
            echo "should_publish=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate package.json
        run: |
          # Check if package.json is valid
          node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))"

          # Check required fields
          REQUIRED_FIELDS=("name" "version" "description" "main" "bin")
          for field in "${REQUIRED_FIELDS[@]}"; do
            if ! jq -e ".$field" package.json > /dev/null; then
              echo "::error::Missing required field: $field"
              exit 1
            fi
          done

  # Quality assurance
  qa:
    name: Quality Assurance
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.should_publish == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: rm -f package-lock.json && npm install --legacy-peer-deps

      - name: Run full validation
        run: npm run validate:all

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Check coverage threshold
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Coverage: $COVERAGE%"

          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "::warning::Coverage is below 80%: $COVERAGE%"
          fi

      - name: Security audit
        run: |
          echo "Running security audit..."
          npm audit --audit-level=moderate
          if [ $? -ne 0 ]; then
            echo "::warning::Security vulnerabilities found. Review before publishing."
          fi

      - name: Check package size
        run: |
          npm pack --dry-run > /dev/null
          PACKAGE_SIZE=$(du -k *.tgz | cut -f1)
          echo "Package size: ${PACKAGE_SIZE}KB"

          if [ $PACKAGE_SIZE -gt 1024 ]; then
            echo "::warning::Package size exceeds 1MB: ${PACKAGE_SIZE}KB"
          fi
          rm -f *.tgz

      - name: Validate binary
        run: |
          npm run build

          # Check if binary exists and is executable
          if [ ! -f "dist/index.js" ]; then
            echo "::error::Binary not found after build"
            exit 1
          fi

          # Test binary help
          timeout 10s node dist/index.js --help || true

  # Build artifacts
  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: [preflight, qa]
    if: needs.preflight.outputs.should_publish == 'true'
    outputs:
      package_hash: ${{ steps.hash.outputs.hash }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: rm -f package-lock.json && npm install --legacy-peer-deps

      - name: Build
        run: npm run build

      - name: Generate package hash
        id: hash
        run: |
          HASH=$(sha256sum dist/index.js | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Package hash: $HASH"

      - name: Create package
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"
          npm version $VERSION --no-git-tag-version
          npm pack

      - name: Upload package artifact
        uses: actions/upload-artifact@v7
        with:
          name: package-${{ needs.preflight.outputs.version }}
          path: "*.tgz"
          retention-days: 30

  # Docker build
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [preflight, qa]
    if: needs.preflight.outputs.should_publish == 'true'
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event.inputs.dry_run != 'true' && github.event.client_payload.dry_run != 'true' && env.DOCKER_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: lucassantana/uiforge-mcp
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event.inputs.dry_run != 'true' && github.event.client_payload.dry_run != 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.preflight.outputs.version }}

      - name: Test Docker image
        run: |
          docker run --rm lucassantana/uiforge-mcp:latest --help || true

  # Publish to npm
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [preflight, qa, build]
    if: needs.preflight.outputs.should_publish == 'true' && github.event.inputs.dry_run != 'true' && github.event.client_payload.dry_run != 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          registry-url: https://registry.npmjs.org

      - name: Download package
        uses: actions/download-artifact@v8
        with:
          name: package-${{ needs.preflight.outputs.version }}

      - name: Publish to npm
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"
          TARBALL=$(ls forgespace-ui-mcp-*.tgz 2>/dev/null || ls *.tgz 2>/dev/null | head -1)
          echo "Publishing $TARBALL"
          npm publish "$TARBALL" --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify publication
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"
          sleep 5
          curl -sf "https://registry.npmjs.org/@forgespace/ui-mcp/$VERSION" | node -e "
            const d = JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));
            console.log('Published:', d.name + '@' + d.version);
          "

  # Create GitHub release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [preflight, qa, build]
    if: always() && needs.build.result == 'success' && (github.event.inputs.create_release == 'true' || github.event.client_payload.create_release == 'true')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download package
        uses: actions/download-artifact@v8
        with:
          name: package-${{ needs.preflight.outputs.version }}

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --max-count=20)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"
          IS_PRE="${{ needs.preflight.outputs.is_prerelease }}"
          PRE_FLAG=""
          if [ "$IS_PRE" = "true" ]; then PRE_FLAG="--prerelease"; fi

          gh release create "v$VERSION" *.tgz \
            --title "Release v$VERSION" \
            --notes "$(cat <<'NOTES'
          ## Release v${{ needs.preflight.outputs.version }}

          ### Package Installation
          ```bash
          npm install -g @forgespace/ui-mcp@${{ needs.preflight.outputs.version }}
          ```

          ### Changes
          ${{ steps.changelog.outputs.changelog }}
          NOTES
          )" $PRE_FLAG

  # Update version and push
  update-version:
    name: Update Version
    runs-on: ubuntu-latest
    needs: [preflight, publish, release]
    if: always() && (needs.publish.result == 'success' || needs.release.result == 'success')
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Update version in package.json
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"
          npm version $VERSION --no-git-tag-version

      - name: Commit and tag
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package.json package-lock.json
          git commit -m "chore: bump version to v$VERSION"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin main --follow-tags

  # Notification
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [preflight, qa, build, docker, publish, release]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.preflight.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ github.event.inputs.dry_run || github.event.client_payload.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "**Create Release:** ${{ github.event.inputs.create_release || github.event.client_payload.create_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-flight | ${{ needs.preflight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Assurance | ${{ needs.qa.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Publish | ${{ needs.publish.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ needs.release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.publish.result }}" == "success" ]]; then
            echo "âœ… Package successfully published to npm!" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ Install with: \`npm install -g uiforge-mcp@${{ needs.preflight.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Publishing failed or was skipped" >> $GITHUB_STEP_SUMMARY
          fi
