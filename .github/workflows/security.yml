# Security Scanning for UIForge MCP
# Aligned with base-security.yml standards

name: Security Scanning

on:
  push:
    branches: [main, dev, release/*]
  pull_request:
    branches: [main, dev, release/*]
  schedule:
    # Run daily at 2 AM UTC (aligned with base-security.yml)
    - cron: '0 2 * * *'
  workflow_dispatch:

# Environment variables (aligned with base-security.yml standards)
env:
  NODE_VERSION: "22"
  SNYK_SEVERITY_THRESHOLD: "high"
  SNYK_ORGANIZATION: "LucasSantana-Dev"

jobs:
  # Snyk Dependency Scanning (Node.js)
  snyk-dependency-scan:
    name: Snyk Node.js Dependency Scan
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
          
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.SNYK_SEVERITY_THRESHOLD }} --org=${{ env.SNYK_ORGANIZATION }}
          
      - name: Upload Snyk results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: snyk.sarif

  # Snyk Code Security Analysis
  snyk-code-scan:
    name: Snyk Code Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
          
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: Run Snyk Code security analysis
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: code --severity-threshold=${{ env.SNYK_SEVERITY_THRESHOLD }} --org=${{ env.SNYK_ORGANIZATION }}
          
      - name: Upload Snyk Code results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: snyk.sarif

  # Snyk Continuous Monitoring
  snyk-monitor:
    name: Snyk Continuous Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
          
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: Monitor dependencies with Snyk
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --org=${{ env.SNYK_ORGANIZATION }}

  # CodeQL Security Analysis (extends base-security.yml)
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      actions: read
      contents: read
      security-events: write
      
    strategy:
      matrix:
        language: ['typescript', 'javascript']
        
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
          
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality
          
      - name: Build project
        run: npm run build
        
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{matrix.language }}"

  # Trufflehog Secret Scanning (extends base-security.yml)
  trufflehog:
    name: Trufflehog Secret Scan
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          
      - name: Run Trufflehog
        uses: trufflesecurity/trufflehog@v3.93.4
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --only-verified
          fail: true

  # Security Summary (extends base-security.yml)
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: [snyk-dependency-scan, snyk-code-scan, snyk-monitor, codeql, trufflehog]
    if: always()
    
    steps:
      - name: Security Scan Summary
        run: |
          echo "ðŸ”’ Security Scanning Complete!"
          echo "ðŸ“Š Snyk Dependencies: ${{ needs.snyk-dependency-scan.result }}"
          echo "ðŸ” Snyk Code Analysis: ${{ needs.snyk-code-scan.result }}"
          echo "ðŸ“Š Snyk Monitor: ${{ needs.snyk-monitor.result }}"
          echo "ðŸ”Ž CodeQL Analysis: ${{ needs.codeql.result }}"
          echo "ðŸ— Trufflehog Secrets: ${{ needs.trufflehog.result }}"
          echo ""
          echo "ðŸš¨ Any failures should be reviewed immediately!"
          echo "ðŸ“‹ Check the Security tab for detailed findings"
          
      - name: Generate Security Summary Report
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk Dependencies | ${{ needs.snyk-dependency-scan.result }} | âœ… Passed or âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk Code Analysis | ${{ needs.snyk-code-scan.result }} | âœ… Passed or âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk Monitor | ${{ needs.snyk-monitor.result }} | âœ… Active or âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql.result }} | âœ… Passed or âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "| Trufflehog Secrets | ${{ needs.trufflehog.result }} | âœ… Passed or âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Security Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Organization**: ${{ env.SNYK_ORGANIZATION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Severity Threshold**: ${{ env.SNYK_SEVERITY_THRESHOLD }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Frequency**: Daily scheduled + event-driven" >> $GITHUB_STEP_SUMMARY
          echo "- **Tools Used**: Snyk, CodeQL, Trufflehog" >> $GITHUB_STEP_SUMMARY
