name: Monitoring Dashboard

on:
  schedule:
    # Run monitoring dashboard daily at 8 AM UTC
    - cron: "0 8 * * *"
  workflow_dispatch:
    inputs:
      generate_report:
        description: "Generate comprehensive monitoring report"
        required: false
        default: true
        type: boolean
      check_health:
        description: "Check overall project health"
        required: false
        default: true
        type: boolean
      send_alerts:
        description: "Send alerts for critical issues"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  health-check:
    name: Project Health Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Check repository health
        run: |
          echo "ðŸ¥ Repository Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check git status
          if [ -n "$(git status --porcelain)" ]; then
            echo "âš ï¸ Repository has uncommitted changes" >> $GITHUB_STEP_SUMMARY
            git status --porcelain >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Repository is clean" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for large files
          LARGE_FILES=$(find . -type f -size +1M -not -path "./node_modules/*" -not -path "./.git/*" | wc -l)
          if [ $LARGE_FILES -gt 0 ]; then
            echo "âš ï¸ Found $LARGE_FILES large files (>1MB)" >> $GITHUB_STEP_SUMMARY
            find . -type f -size +1M -not -path "./node_modules/*" -not -path "./.git/*" -exec ls -lh {} \; >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No large files found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check build health
        run: |
          echo "ðŸ”¨ Build Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if npm run build 2>/dev/null; then
            echo "âœ… Build successful" >> $GITHUB_STEP_SUMMARY

            if [ -f dist/index.js ]; then
              SIZE=$(stat -c%s dist/index.js)
              SIZE_KB=$((SIZE / 1024))
              echo "âœ… Bundle created: ${SIZE_KB}KB" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Build failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Check test health
        run: |
          echo "ðŸ§ª Test Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if npm test 2>/dev/null; then
            echo "âœ… All tests pass" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Check coverage health
        run: |
          echo "ðŸ“Š Coverage Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if npm run test:coverage 2>/dev/null; then
            if [ -f coverage/coverage-summary.json ]; then
              LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct // 0')
              echo "âœ… Coverage: ${LINES}%" >> $GITHUB_STEP_SUMMARY

              if (( $(echo "$LINES >= 80" | bc -l) )); then
                echo "âœ… Coverage threshold met" >> $GITHUB_STEP_SUMMARY
              else
                echo "âš ï¸ Coverage below threshold (80%)" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âŒ Coverage report not found" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Coverage tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Generate health score
        if: github.event.inputs.generate_report == 'true'
        run: |
          echo "## ðŸ¥ Project Health Score" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SCORE=100

          # Check various health metrics
          if [ -n "$(git status --porcelain)" ]; then
            SCORE=$((SCORE - 10))
          fi

          if [ $LARGE_FILES -gt 0 ]; then
            SCORE=$((SCORE - 5))
          fi

          if [ $LINES -lt 80 ]; then
            SCORE=$((SCORE - 15))
          fi

          echo "**Overall Health Score: $SCORE/100**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $SCORE -ge 90 ]; then
            echo "ðŸŸ¢ **Excellent** - Project is in excellent health!" >> $GITHUB_STEP_SUMMARY
          elif [ $SCORE -ge 70 ]; then
            echo "ðŸŸ¡ **Good** - Project is healthy" >> $GITHUB_STEP_SUMMARY
          elif [ $SCORE -ge 50 ]; then
            echo "ðŸŸ  **Fair** - Some attention needed" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ”´ **Poor** - Immediate attention required" >> $GITHUB_STEP_SUMMARY
          fi

  metrics-collection:
    name: Collect Metrics
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Collect project metrics
        run: |
          echo "ðŸ“Š Project Metrics Collection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Repository metrics
          COMMITS=$(git rev-list --count HEAD)
          BRANCHES=$(git branch -a | wc -l)
          TAGS=$(git tag -l | wc -l)

          echo "### ðŸ“ˆ Repository Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Total Commits: $COMMITS" >> $GITHUB_STEP_SUMMARY
          echo "- Branches: $BRANCHES" >> $GITHUB_STEP_SUMMARY
          echo "- Tags: $TAGS" >> $GITHUB_STEP_SUMMARY
          echo "- Repository Size: $(du -sh . | tail -1 | cut -f1)" >> $GITHUB_STEP_SUMMARY

          # Code metrics
          TS_FILES=$(find src -name "*.ts" | wc -l)
          JS_FILES=$(find src -name "*.js" | wc -l)
          TOTAL_FILES=$(find src -type f | wc -l)

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’» Code Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript Files: $TS_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript Files: $JS_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- Total Source Files: $TOTAL_FILES" >> $GITHUB_STEP_SUMMARY

          # Dependency metrics
          DEPS=$(cat package.json | jq '.dependencies | keys | length' 2>/dev/null || echo "0")
          DEV_DEPS=$(cat package.json | jq '.devDependencies | keys | length' 2>/dev/null || echo "0")

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Dependency Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Production Dependencies: $DEPS" >> $GITHUB_STEP_SUMMARY
          echo "- Development Dependencies: $DEV_DEPS" >> $GITHUB_STEP_SUMMARY
          echo "- Total Dependencies: $(($DEPS + $DEV_DEPS))" >> $GITHUB_STEP_SUMMARY

          # Test metrics
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct // 0')
            FUNCTIONS=$(cat coverage/coverage-summary.json | jq '.total.functions.pct // 0')
            BRANCHES=$(cat coverage/coverage-summary.json | jq '.total.branches.pct // 0')
            STATEMENTS=$(cat coverage/coverage-summary.json | jq '.total.statements.pct // 0')

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ§ª Test Coverage Metrics" >> $GITHUB_STEP_SUMMARY
            echo "- Lines: ${LINES}%" >> $GITHUB_STEP_SUMMARY
            echo "- Functions: ${FUNCTIONS}%" >> $GITHUB_STEP_SUMMARY
            echo "- Branches: ${BRANCHES}%" >> $GITHUB_STEP_SUMMARY
            echo "- Statements: ${STATEMENTS}%" >> $GITHUB_STEP_SUMMARY
          fi

          # Build metrics
          if [ -f dist/index.js ]; then
            SIZE=$(stat -c%s dist/index.js)
            SIZE_KB=$((SIZE / 1024))
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Build Metrics" >> $GITHUB_STEP_SUMMARY
            echo "- Bundle Size: ${SIZE_KB}KB" >> $GITHUB_STEP_SUMMARY
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium
          command: monitor

      - name: Run CodeQL analysis
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v4

      - name: Generate security report
        run: |
          echo "ðŸ”’ Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ›¡ï¸ Security Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Snyk dependency scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CodeQL static analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Results uploaded to Security tab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ” Review Findings" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the **Security** tab in this repository" >> $GITHUB_STEP_SUMMARY
          echo "2. Review high and medium severity issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Address critical vulnerabilities promptly" >> $GITHUB_STEP_SUMMARY
          echo "4. Monitor for new security alerts" >> $GITHUB_STEP_SUMMARY

  alert-team:
    name: Send Alerts
    runs-on: ubuntu-latest
    if: github.event.inputs.send_alerts == 'true' || failure()
    needs: [health-check, metrics-collection, security-scan]
    steps:
      - name: Check for critical issues
        id: check_issues
        run: |
          echo "ðŸš¨ Checking for critical issues..."
